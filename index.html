<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>タイピングくん</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        /* --- [START] デザインシステム --- */
        :root, .theme-light { /* Paper Theme */
            --bg-color: #f1f5f9;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #1e293b;
            --text-color-secondary: #64748b;
            --header-text-color: #1e293b;
            --primary-color: #0ea5e9; /* sky-500 */
            --primary-color-rgb: 14, 165, 233;
            --primary-text-color: #ffffff;
            --border-color: #e2e8f0; /* slate-200 */
            --danger-color: #ef4444;
            --success-color: #22c55e;
            --toast-bg-color: rgba(29, 78, 216, 0.9);

            /* タイピングくん独自変数 */
            --next-char-bg-color: #e0f2fe; /* sky-100 */
            --correct-char-color: #166534; /* green-800 */
            --incorrect-char-color: #991b1b; /* red-800 */
            --incorrect-char-bg-color: #fee2e2; /* red-100 */
            --progress-bar-color: #38bdf8; /* sky-400 */
        }
        .theme-dark { /* Midnight Theme */
            --bg-color: #0f172a;
            --header-bg-color: #1e293b;
            --card-bg-color: #334155;
            --text-color: #e2e8f0;
            --text-color-secondary: #94a3b8;
            --header-text-color: var(--text-color);
            --primary-color: #f97316; /* orange-500 */
            --primary-color-rgb: 249, 115, 22;
            --primary-text-color: #ffffff;
            --border-color: #475569;
            --danger-color: #fca5a5;
            --success-color: #86efac;
            --toast-bg-color: rgba(234, 88, 12, 0.9);
            
            --next-char-bg-color: #475569;
            --correct-char-color: #bbf7d0; /* green-200 */
            --incorrect-char-color: #fca5a5; /* red-300 */
            --incorrect-char-bg-color: #450a0a; /* red-950 */
            --progress-bar-color: var(--primary-color);
        }
        .theme-sakura {
            --bg-color: #fdf2f8;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #832c56;
            --text-color-secondary: #be185d;
            --header-text-color: #832c56;
            --primary-color: #ec4899;
            --primary-color-rgb: 236, 72, 153;
            --primary-text-color: #ffffff;
            --border-color: #fbcfe8;
            --danger-color: #f43f5e;
            --success-color: #16a34a;
            --toast-bg-color: rgba(190, 24, 93, 0.9);

            --next-char-bg-color: #fce7f3; /* pink-100 */
            --correct-char-color: #14532d;
            --incorrect-char-color: #881337;
            --incorrect-char-bg-color: #fecdd3;
            --progress-bar-color: var(--primary-color);
        }
        .theme-matcha {
            --bg-color: #f7fee7;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #1a2e05;
            --text-color-secondary: #3f6212;
            --header-text-color: #1a2e05;
            --primary-color: #4d7c0f;
            --primary-color-rgb: 77, 124, 15;
            --primary-text-color: #ffffff;
            --border-color: #dcfce7;
            --danger-color: #dc2626;
            --success-color: #166534;
            --toast-bg-color: rgba(63, 98, 18, 0.9);
            
            --next-char-bg-color: #dcfce7;
            --correct-char-color: #14532d;
            --incorrect-char-color: #7f1d1d;
            --incorrect-char-bg-color: #fee2e2;
            --progress-bar-color: #84cc16;
        }
        .theme-mizu { /* Ocean Theme */
            --bg-color: #ecfeff;
            --header-bg-color: #ffffff;
            --card-bg-color: #ffffff;
            --text-color: #1e3a8a;
            --text-color-secondary: #1d4ed8;
            --header-text-color: #1e3a8a;
            --primary-color: #06b6d4;
            --primary-color-rgb: 6, 182, 212;
            --primary-text-color: #ffffff;
            --border-color: #a5f3fc;
            --danger-color: #e11d48;
            --success-color: #059669;
            --toast-bg-color: rgba(13, 148, 136, 0.9);

            --next-char-bg-color: #cffafe;
            --correct-char-color: #047857;
            --incorrect-char-color: #9f1239;
            --incorrect-char-bg-color: #fecdd3;
            --progress-bar-color: var(--primary-color);
        }
        .theme-yuyake { /* Twilight Theme */
            --bg-color: #2c244d;
            --header-bg-color: #312e81;
            --card-bg-color: #4338ca;
            --text-color: #ddd6fe;
            --text-color-secondary: #a5b4fc;
            --header-text-color: var(--text-color);
            --primary-color: #f59e0b;
            --primary-color-rgb: 245, 158, 11;
            --primary-text-color: #ffffff;
            --border-color: #4f46e5;
            --danger-color: #fca5a5;
            --success-color: #86efac;
            --toast-bg-color: rgba(245, 158, 11, 0.9);
            
            --next-char-bg-color: #4f46e5;
            --correct-char-color: #bbf7d0;
            --incorrect-char-color: #fca5a5;
            --incorrect-char-bg-color: #7f1d1d;
            --progress-bar-color: var(--primary-color);
        }
        /* --- [END] デザインシステム --- */

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        header { background-color: var(--header-bg-color); color: var(--header-text-color); }
        .main-card { background-color: var(--card-bg-color); max-width: 800px; }
        .control-button {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            transition: all 0.2s ease-in-out;
        }
        .control-button:hover:not(:disabled) {
            opacity: 0.85;
            transform: translateY(-2px);
        }
        .control-button:disabled {
            background-color: var(--border-color);
            color: var(--text-color-secondary);
            cursor: not-allowed;
            opacity: 0.7;
        }
        .problem-area {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            cursor: text;
        }
        .problem-area.game-in-progress {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(var(--primary-color-rgb), 0.3);
        }
        #problemTextStatic { color: var(--text-color-secondary); }
        #problemTextDynamic { font-family: 'Roboto Mono', monospace; }
        .char-span {
            border-bottom: 3px solid transparent;
            transition: color 0.2s, background-color 0.2s, border-color 0.2s;
        }
        .char-span.next-char-highlight {
            background-color: var(--next-char-bg-color);
            border-bottom-color: var(--primary-color);
            border-radius: 3px;
        }
        .char-span.correct { color: var(--correct-char-color); border-bottom-color: transparent; }
        .char-span.incorrect {
            background-color: var(--incorrect-char-bg-color);
            color: var(--incorrect-char-color);
            border-radius: 3px;
        }
        .char-span.incorrect-space { background-color: var(--incorrect-char-bg-color); }
        .game-info-value { color: var(--primary-color); }
        .progress-bar-container { background-color: var(--border-color); }
        #gameProgressBar { background-color: var(--progress-bar-color); transition: width 0.25s ease-out; }
        #inputField { position: absolute; left: -9999px; opacity: 0; }
        .modal { display: none; background-color: rgba(0,0,0,0.5); }
        .modal.show { display: flex; }
        .modal-content {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            max-height: 90vh;
        }
        .modal-header { border-bottom: 1px solid var(--border-color); }
        .modal-close-btn { color: var(--text-color-secondary); transition: color 0.2s; }
        .modal-close-btn:hover { color: var(--text-color); }
        .modal-input, .modal-select {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .modal-input:focus, .modal-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(var(--primary-color-rgb), 0.2);
        }
        .modal-button { background-color: var(--primary-color); color: var(--primary-text-color); }
        .modal-button.secondary { background-color: var(--border-color); color: var(--text-color); }
        .modal-button.danger { background-color: var(--danger-color); color: white; }
        .modal-button.success { background-color: var(--success-color); color: white; }
        
        .theme-selector-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .theme-selector-container .option {
            padding: 0.5rem 1rem;
            border-radius: 999px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            border: 1px solid var(--border-color);
        }
        .theme-selector-container .option:hover {
             border-color: var(--primary-color);
        }
        .theme-selector-container .option.selected {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            border-color: var(--primary-color);
        }

        .toggle-switch .slider { background-color: #ccc; }
        .toggle-switch input:checked + .slider { background-color: var(--primary-color); }
        .toggle-switch input:checked + .slider .dot { transform: translateX(24px); }
        #toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        .toast-message {
            padding: 0.75rem 1.25rem;
            border-radius: 999px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateY(20px);
            animation: toast-slide-in 0.3s ease-out forwards, toast-fade-out 0.5s ease-in forwards 2.7s;
            font-size: 0.95rem;
        }
        .toast-message.success { background-color: var(--success-color); }
        .toast-message.error { background-color: var(--danger-color); }
        .toast-message.info { background-color: var(--toast-bg-color); }
        .toast-message i { margin-right: 0.5rem; }
        @keyframes toast-slide-in { to { opacity: 1; transform: translateY(0); } }
        @keyframes toast-fade-out { to { opacity: 0; transform: translateY(10px); } }
    </style>
</head>
<body class="theme-light">

    <header class="shadow-md sticky top-0 z-20">
        <div class="container mx-auto px-4 h-16 flex justify-between items-center">
            <h1 class="text-xl font-bold">タイピングくん</h1>
            <button id="settingsBtn" class="p-2 rounded-full hover:bg-black/10 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-6">
        <div class="main-card rounded-xl p-6 md:p-8 shadow-lg mx-auto">
            
            <input type="text" id="inputField">

            <div class="control-area grid grid-cols-2 sm:grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                <button id="startBtn" class="control-button rounded-lg py-2 px-4 font-semibold text-lg flex items-center justify-center gap-2"><i class="fas fa-play"></i> スタート</button>
                <button id="resetBtn" class="control-button rounded-lg py-2 px-4 font-semibold text-lg flex items-center justify-center gap-2"><i class="fas fa-redo"></i> リセット</button>
                <button id="wordRegistrationBtn" class="control-button rounded-lg py-2 px-4 font-semibold flex items-center justify-center gap-2"><i class="fas fa-edit"></i> 単語管理</button>
                <button id="totalStatsBtn" class="control-button rounded-lg py-2 px-4 font-semibold flex items-center justify-center gap-2"><i class="fas fa-chart-bar"></i> 累計統計</button>
            </div>
            
            <div class="problem-area rounded-lg p-4 mb-4" tabindex="0">
                <div class="progress-bar-container h-2 rounded-full mb-3">
                    <div id="gameProgressBar" class="h-full rounded-full"></div>
                </div>
                <div id="problemTextStatic" class="text-lg text-center mb-2 min-h-[1.75rem]">準備完了。スタートボタンまたはスペースキーで問題表示！</div>
                <div id="problemTextDynamic" class="text-4xl md:text-5xl text-center min-h-[4rem] flex justify-center items-center flex-wrap py-2"></div>
            </div>

            <div id="gameInfo" class="flex justify-around items-center w-full max-w-sm mx-auto mt-6 text-2xl font-semibold">
                <div class="text-center">
                    <span class="text-base text-[var(--text-color-secondary)]">時間</span>
                    <div class="game-info-value"><span id="countdownDisplay">--</span></div>
                </div>
                <div class="text-center">
                    <span class="text-base text-[var(--text-color-secondary)]">KPM</span>
                    <div class="game-info-value"><span id="currentKpmDisplay">0</span></div>
                </div>
            </div>
        </div>
    </main>

    <div id="toast-container"></div>

    <!-- Modals -->
    <div id="settingsModal" class="modal fixed inset-0 z-30 p-4 items-center justify-center">
        <div class="modal-content w-full max-w-2xl rounded-lg shadow-xl relative flex flex-col">
            <header class="modal-header p-4 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">設定</h2>
                <button class="modal-close-btn" data-modal="settingsModal"><i class="fas fa-times text-2xl"></i></button>
            </header>
            
            <main class="p-6 overflow-y-auto">
                <div class="mb-6">
                    <label class="block mb-2 font-semibold text-[var(--text-color-secondary)]">テーマ</label>
                    <div id="theme-selector" class="theme-selector-container">
                        <button class="option" data-value="light">Paper</button>
                        <button class="option" data-value="dark">Midnight</button>
                        <button class="option" data-value="sakura">Sakura</button>
                        <button class="option" data-value="matcha">Matcha</button>
                        <button class="option" data-value="mizu">Ocean</button>
                        <button class="option" data-value="yuyake">Twilight</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="modeSelect" class="block mb-2 font-semibold text-[var(--text-color-secondary)]">モード</label>
                        <select id="modeSelect" class="modal-select w-full p-2 rounded-lg text-lg">
                            <option value="normal">通常</option>
                            <option value="timeLimit">時間制限</option>
                        </select>
                    </div>
                    <div id="normalModeOptions">
                        <label for="normalModeProblemCountSelect" class="block mb-2 font-semibold text-[var(--text-color-secondary)]">問題数</label>
                        <select id="normalModeProblemCountSelect" class="modal-select w-full p-2 rounded-lg text-lg">
                            <option value="10">10問</option> <option value="25">25問</option> <option value="50" selected>50問</option> <option value="100">100問</option>
                        </select>
                    </div>
                    <div id="timeLimitOptions" class="hidden">
                        <label for="timeLimitSelect" class="block mb-2 font-semibold text-[var(--text-color-secondary)]">時間 (秒)</label>
                        <select id="timeLimitSelect" class="modal-select w-full p-2 rounded-lg text-lg">
                            <option value="30">30秒</option> <option value="60" selected>60秒</option> <option value="90">90秒</option> <option value="120">120秒</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-between items-center p-3 rounded-lg bg-[var(--bg-color)] mb-6">
                    <label for="soundToggle" class="font-semibold text-lg">効果音</label>
                    <div class="toggle-switch relative inline-block">
                        <input type="checkbox" id="soundToggle" class="opacity-0 w-0 h-0">
                        <label for="soundToggle" class="slider cursor-pointer block w-12 h-6 rounded-full relative transition-colors bg-gray-300">
                            <span class="dot absolute block w-4 h-4 bg-white rounded-full top-1 left-1 transition-transform"></span>
                        </label>
                    </div>
                </div>
                
                <hr class="border-[var(--border-color)] my-4">

                <div>
                    <h3 class="text-xl font-bold mb-3">読み上げ設定</h3>
                    <div class="flex justify-between items-center p-3 rounded-lg bg-[var(--bg-color)] mb-4">
                        <label for="readAloudToggle" class="font-semibold text-lg">読み上げ機能</label>
                        <div class="toggle-switch relative inline-block">
                             <input type="checkbox" id="readAloudToggle" class="opacity-0 w-0 h-0">
                             <label for="readAloudToggle" class="slider cursor-pointer block w-12 h-6 rounded-full relative transition-colors bg-gray-300">
                                <span class="dot absolute block w-4 h-4 bg-white rounded-full top-1 left-1 transition-transform"></span>
                            </label>
                        </div>
                    </div>
                    <div id="readAloudOptionsContainer" class="hidden space-y-4">
                        <div class="mb-4">
                           <label for="readAloudTargetSelect" class="block mb-1 font-semibold text-sm">読み上げる箇所</label>
                           <select id="readAloudTargetSelect" class="modal-select w-full">
                               <option value="prompt">提示文のみ</option>
                               <option value="typing">タイプ文のみ</option>
                               <option value="both">両方</option>
                           </select>
                       </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="readAloudVoiceJaSelect" class="block mb-1 font-semibold text-sm">提示文の音声 (日本語)</label>
                                <select id="readAloudVoiceJaSelect" class="modal-select w-full"></select>
                            </div>
                            <div>
                                <label for="readAloudRateJaSelect" class="block mb-1 font-semibold text-sm">提示文の速度</label>
                                <select id="readAloudRateJaSelect" class="modal-select w-full">
                                    <option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1" selected>1.0x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2.0x</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                           <div>
                               <label for="readAloudVoiceEnSelect" class="block mb-1 font-semibold text-sm">タイプ文の音声 (英語)</label>
                               <select id="readAloudVoiceEnSelect" class="modal-select w-full"></select>
                           </div>
                           <div>
                               <label for="readAloudRateEnSelect" class="block mb-1 font-semibold text-sm">タイプ文の速度</label>
                               <select id="readAloudRateEnSelect" class="modal-select w-full">
                                   <option value="0.5">0.5x</option><option value="0.75">0.75x</option><option value="1" selected>1.0x</option><option value="1.25">1.25x</option><option value="1.5">1.5x</option><option value="2">2.0x</option>
                               </select>
                           </div>
                       </div>
                    </div>
                </div>

            </main>
             <footer class="p-4 mt-auto text-center flex-shrink-0">
                <p class="text-xs text-[var(--text-color-secondary)]">設定は自動的に保存されます。</p>
            </footer>
        </div>
    </div>
    
    <div id="wordRegistrationModal" class="modal fixed inset-0 z-40 p-4 items-center justify-center">
        <div class="modal-content w-full max-w-4xl rounded-lg shadow-xl relative flex flex-col">
             <header class="modal-header p-4 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">単語とリストの管理</h2>
                <button class="modal-close-btn" data-modal="wordRegistrationModal"><i class="fas fa-times text-2xl"></i></button>
            </header>
            <main class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 p-6 overflow-y-auto">
                <div class="flex flex-col">
                    <h3 class="text-lg font-semibold mb-3 text-[var(--text-color-secondary)]">単語リスト <span class="text-sm font-normal">(☑で練習対象)</span></h3>
                    <div class="mb-3">
                        <label for="newListNameInput" class="block mb-1 text-sm font-medium">新しいリスト名</label>
                        <div class="flex items-center gap-2">
                            <input type="text" id="newListNameInput" placeholder="例: 基本単語" class="modal-input flex-grow p-2 rounded-md">
                            <button id="createWordListBtn" class="modal-button success p-2 rounded-md aspect-square flex-shrink-0"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <div id="manageWordListsContainer" class="flex-grow overflow-y-auto border border-[var(--border-color)] p-2 rounded-lg bg-[var(--bg-color)] min-h-[200px]">
                    </div>
                </div>
                <div class="space-y-6">
                     <div>
                        <h3 class="text-lg font-semibold mb-3 text-[var(--text-color-secondary)]">単語登録</h3>
                        <div class="space-y-3">
                            <div>
                               <label for="addWordToListSelect" class="block mb-1 text-sm font-medium">登録先リスト</label>
                               <select id="addWordToListSelect" class="modal-select w-full p-2 rounded-md"></select>
                            </div>
                            <div>
                               <label for="newWordNoteInput" class="block mb-1 text-sm font-medium">表示する日本語 (お題)</label>
                               <input type="text" id="newWordNoteInput" placeholder="例: こんにちは" class="modal-input w-full p-2 rounded-md">
                            </div>
                            <div>
                               <label for="newWordDisplayInput" class="block mb-1 text-sm font-medium">タイプする文字列 (ローマ字)</label>
                               <input type="text" id="newWordDisplayInput" placeholder="例: konnichiha" class="modal-input w-full p-2 rounded-md">
                            </div>
                             <button id="addWordBtn" class="modal-button w-full py-2 rounded-md font-semibold"><i class="fas fa-plus-circle"></i> この単語をリストに追加</button>
                        </div>
                    </div>
                     <div>
                        <h3 class="text-lg font-semibold mb-3 text-[var(--text-color-secondary)]">ファイルから一括登録</h3>
                        <div class="space-y-3">
                            <div>
                               <label for="addWordsFromFileToListSelect" class="block mb-1 text-sm font-medium">登録先リスト</label>
                               <select id="addWordsFromFileToListSelect" class="modal-select w-full p-2 rounded-md mb-2"></select>
                            </div>
                           <input type="file" id="wordFileInput" accept=".txt,.csv" class="modal-input w-full">
                           <div class="mt-2 text-sm">
                               <p class="font-semibold">ファイル形式</p>
                               <div class="flex flex-col items-start"><label class="mr-2"><input type="radio" name="fileFormat" value="type_prompt" checked> タイプ文, 表示文</label><label><input type="radio" name="fileFormat" value="prompt_type"> 表示文, タイプ文</label></div>
                           </div>
                        </div>
                    </div>
                </div>
            </main>
             <footer class="p-4 border-t border-[var(--border-color)]">
                <details>
                    <summary class="font-semibold cursor-pointer">登録済み単語の確認・修正</summary>
                     <div class="mt-2">
                        <select id="viewRegisteredWordsListSelect" class="modal-select text-sm py-1 flex-grow mr-2 w-full"></select>
                        <div id="registeredWordsList" class="max-h-40 overflow-y-auto border p-2 rounded mt-2 bg-[var(--bg-color)]"></div>
                    </div>
                </details>
             </footer>
        </div>
    </div>
    
    <div id="resultsModal" class="modal fixed inset-0 z-50 p-4 items-center justify-center">
         <div class="modal-content w-full max-w-md rounded-lg shadow-xl relative flex flex-col">
             <header class="modal-header p-4 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">結果</h2>
                <button class="modal-close-btn" data-modal="resultsModal"><i class="fas fa-times text-2xl"></i></button>
            </header>
            <main class="p-6 text-center">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg">
                        <div class="text-sm text-[var(--text-color-secondary)]">KPM</div>
                        <div id="modalKpmDisplay" class="text-3xl font-bold text-[var(--primary-color)]">0</div>
                    </div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg">
                        <div class="text-sm text-[var(--text-color-secondary)]">正解率</div>
                        <div id="modalAccuracyDisplay" class="text-3xl font-bold text-[var(--primary-color)]">0%</div>
                    </div>
                     <div class="bg-[var(--bg-color)] p-3 rounded-lg">
                        <div class="text-sm text-[var(--text-color-secondary)]">時間</div>
                        <div id="modalTimeDisplay" class="text-xl font-semibold">0.0</div>
                    </div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg">
                        <div class="text-sm text-[var(--text-color-secondary)]">タイプ数</div>
                        <div id="modalTypedCharsDisplay" class="text-xl font-semibold">0</div>
                    </div>
                     <div class="bg-[var(--bg-color)] p-3 rounded-lg col-span-2">
                        <div class="text-sm text-[var(--text-color-secondary)]">ミス数</div>
                        <div id="modalMissesDisplay" class="text-xl font-semibold">0</div>
                    </div>
                </div>
                <div class="mb-4">
                    <h3 class="text-md font-semibold mb-2 text-left text-[var(--text-color-secondary)]">間違えやすいキー</h3>
                    <div id="modalMistypedStatsList" class="flex flex-wrap gap-2 text-sm justify-center p-2 bg-[var(--bg-color)] rounded-lg min-h-[40px]"></div>
                </div>
            </main>
            <footer class="p-4 flex-shrink-0">
                <button id="retryBtnModal" class="modal-button w-full py-3 rounded-lg text-lg font-bold"><i class="fas fa-redo"></i> もう一度</button>
            </footer>
        </div>
    </div>
    
    <div id="totalStatsModal" class="modal fixed inset-0 z-50 p-4 items-center justify-center">
         <div class="modal-content w-full max-w-lg rounded-lg shadow-xl relative flex flex-col">
             <header class="modal-header p-4 flex justify-between items-center flex-shrink-0">
                <h2 class="text-xl font-bold">累計統計</h2>
                <button class="modal-close-btn" data-modal="totalStatsModal"><i class="fas fa-times text-2xl"></i></button>
            </header>
            <main class="p-6">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6 text-center">
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg"><div class="text-sm text-[var(--text-color-secondary)]">総プレイ回数</div><div id="totalPlaysStat" class="text-xl font-semibold">0</div></div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg"><div class="text-sm text-[var(--text-color-secondary)]">総プレイ時間</div><div id="totalPlayTimeStat" class="text-xl font-semibold">0秒</div></div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg"><div class="text-sm text-[var(--text-color-secondary)]">総タイプ文字数</div><div id="totalTypedCharactersStat" class="text-xl font-semibold">0</div></div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg"><div class="text-sm text-[var(--text-color-secondary)]">総ミスタイプ数</div><div id="totalOverallMistakesStat" class="text-xl font-semibold">0</div></div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg"><div class="text-sm text-[var(--text-color-secondary)]">平均KPM</div><div id="avgKpmStat" class="text-xl font-semibold">0</div></div>
                    <div class="bg-[var(--bg-color)] p-3 rounded-lg"><div class="text-sm text-[var(--text-color-secondary)]">平均正解率</div><div id="avgAccuracyStat" class="text-xl font-semibold">0%</div></div>
                </div>
                <div class="mb-4">
                    <h3 class="text-md font-semibold mb-2 text-left text-[var(--text-color-secondary)]">累計 間違えやすいキー Top 5</h3>
                    <div id="totalMistypedKeysList" class="flex flex-wrap gap-2 text-sm justify-center p-2 bg-[var(--bg-color)] rounded-lg min-h-[40px]"></div>
                </div>
            </main>
            <footer class="p-4 flex-shrink-0 border-t border-[var(--border-color)]">
                <button id="resetAllStatsBtn" class="modal-button danger w-full py-2 rounded-lg font-bold"><i class="fas fa-exclamation-triangle"></i> 全統計リセット</button>
            </footer>
        </div>
    </div>
    
    <div id="renameListModal" class="modal fixed inset-0 z-50 p-4 items-center justify-center">
        <div class="modal-content w-full max-w-sm rounded-lg shadow-xl p-6">
            <h3 class="text-lg font-bold mb-4">リスト名変更</h3>
            <input type="text" id="editListNameInput" class="modal-input w-full p-2 rounded-md mb-4">
            <div class="flex justify-end gap-2">
                <button id="cancelRenameListBtn" class="modal-button secondary px-4 py-2 rounded-lg font-semibold">キャンセル</button>
                <button id="saveRenameListBtn" class="modal-button success px-4 py-2 rounded-lg font-semibold">保存</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="modal fixed inset-0 z-50 p-4 items-center justify-center">
        <div class="modal-content w-full max-w-sm rounded-lg shadow-xl p-6 text-center">
            <p id="confirmMessageText" class="mb-6 text-lg"></p>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="modal-button secondary w-full py-2 rounded-lg font-semibold">キャンセル</button>
                <button id="confirmOkBtn" class="modal-button danger w-full py-2 rounded-lg font-semibold">OK</button>
            </div>
        </div>
    </div>

    <script>
        // --- グローバル変数 ---
        // DOM要素
        let startBtn, resetBtn, wordRegistrationBtn, totalStatsBtn, settingsBtn;
        let problemTextStaticElement, problemTextDynamicElement, inputField, countdownDisplay, currentKpmDisplay;
        let gameProgressBar, problemAreaElement;
        let settingsModal, wordRegistrationModal, resultsModal, totalStatsModal, customConfirmModal, renameListModal;
        let modeSelect, timeLimitSelect, timeLimitOptions, soundToggle, normalModeProblemCountSelect, normalModeOptions;
        let themeSelector;
        let confirmMessageText, confirmOkBtn, confirmCancelBtn;
        let renameListIdInput, editListNameInput, saveRenameListBtn, cancelRenameListBtn;
        let newListNameInput, createWordListBtn, manageWordListsContainer;
        let addWordToListSelect, newWordDisplayInput, newWordNoteInput, addWordBtn;
        let addWordsFromFileToListSelect, wordFileInput, fileFormatRadios;
        let viewRegisteredWordsListSelect, registeredWordsListElement;
        let modalKpmDisplay, modalAccuracyDisplay, modalTimeDisplay, modalMissesDisplay, modalTypedCharsDisplay, modalMistypedStatsList;
        let retryBtnModal;
        let totalPlaysStat, totalPlayTimeStat, totalTypedCharactersStat, totalOverallMistakesStat, avgKpmStat, avgAccuracyStat, totalMistypedKeysListElement, resetAllStatsBtn;
        let readAloudToggle, readAloudOptionsContainer, readAloudTargetSelect, readAloudVoiceJaSelect, readAloudRateJaSelect, readAloudVoiceEnSelect, readAloudRateEnSelect;
        
        // ゲーム状態
        let wordLists = [];
        let currentWords = [];
        let currentProblem = null;
        let currentProblemCharIndex = 0;
        let problemToType = "";
        let practiceSessionWordPool = [];
        let practiceSessionWordPoolIndex = 0;
        let problemSet = [];
        let problemSetIndex = 0;
        let gameActive = false;
        let gamePendingStart = false;
        let gameStartTime;
        let timerInterval;
        let wordCompleted = false;

        // 統計
        let correctStrokes = 0, incorrectStrokes = 0, totalTypedInGame = 0;
        let mistypedKeysStats = {}, totalMistypedKeys = {};
        
        // 設定
        let currentMode = 'normal', currentTimeLimit = 60, currentNormalModeProblemCount = 50;
        let soundEnabled = true, currentTheme = 'light';
        let readAloudSettings = { enabled: false, target: 'prompt', voiceJaURI: '', rateJa: 1, voiceEnURI: '', rateEn: 1 };
        let confirmResolve = null, renameListResolve = null;
        let synthVoices = [];

        // LocalStorageキー
        const WORD_LISTS_KEY = 'typingAppWordLists_v1';
        const TOTAL_MISTYPED_KEYS_KEY = 'typingAppTotalMistypedKeys_v2';
        const TOTAL_PLAY_STATS_KEY = 'typingAppTotalPlayStats_v2';
        const SETTINGS_KEY = 'typingAppDesignSettings_v4';
        
        // サウンド
        let synth, errSynth, correctSynth, startSynth, endSynth;
        let audioContextStarted = false;

        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMElements();
            setupEventListeners();
            initSpeechSynthesis();
            loadSettings();
            loadWordLists();
            loadTotalMistypedKeys();
            loadTotalPlayStats();
            updateCurrentWordsListFromSelections();
            loadInitialProblemDisplay();
        });

        function initializeDOMElements() {
            startBtn = document.getElementById('startBtn');
            resetBtn = document.getElementById('resetBtn');
            wordRegistrationBtn = document.getElementById('wordRegistrationBtn');
            totalStatsBtn = document.getElementById('totalStatsBtn');
            settingsBtn = document.getElementById('settingsBtn');
            problemTextStaticElement = document.getElementById('problemTextStatic');
            problemTextDynamicElement = document.getElementById('problemTextDynamic');
            problemAreaElement = document.querySelector('.problem-area');
            inputField = document.getElementById('inputField');
            countdownDisplay = document.getElementById('countdownDisplay');
            currentKpmDisplay = document.getElementById('currentKpmDisplay');
            gameProgressBar = document.getElementById('gameProgressBar');
            
            settingsModal = document.getElementById('settingsModal');
            wordRegistrationModal = document.getElementById('wordRegistrationModal');
            resultsModal = document.getElementById('resultsModal');
            totalStatsModal = document.getElementById('totalStatsModal');
            customConfirmModal = document.getElementById('customConfirmModal');
            renameListModal = document.getElementById('renameListModal');

            confirmMessageText = document.getElementById('confirmMessageText');
            confirmOkBtn = document.getElementById('confirmOkBtn');
            confirmCancelBtn = document.getElementById('confirmCancelBtn');

            editListNameInput = document.getElementById('editListNameInput');
            saveRenameListBtn = document.getElementById('saveRenameListBtn');
            cancelRenameListBtn = document.getElementById('cancelRenameListBtn');
            
            modeSelect = document.getElementById('modeSelect');
            timeLimitSelect = document.getElementById('timeLimitSelect');
            timeLimitOptions = document.getElementById('timeLimitOptions');
            normalModeProblemCountSelect = document.getElementById('normalModeProblemCountSelect');
            normalModeOptions = document.getElementById('normalModeOptions');
            soundToggle = document.getElementById('soundToggle');
            themeSelector = document.getElementById('theme-selector');
            
            newListNameInput = document.getElementById('newListNameInput');
            createWordListBtn = document.getElementById('createWordListBtn');
            manageWordListsContainer = document.getElementById('manageWordListsContainer');
            addWordToListSelect = document.getElementById('addWordToListSelect');
            newWordDisplayInput = document.getElementById('newWordDisplayInput');
            newWordNoteInput = document.getElementById('newWordNoteInput');
            addWordBtn = document.getElementById('addWordBtn');
            addWordsFromFileToListSelect = document.getElementById('addWordsFromFileToListSelect');
            wordFileInput = document.getElementById('wordFileInput');
            fileFormatRadios = document.querySelectorAll('input[name="fileFormat"]');
            viewRegisteredWordsListSelect = document.getElementById('viewRegisteredWordsListSelect');
            registeredWordsListElement = document.getElementById('registeredWordsList');
            
            modalKpmDisplay = document.getElementById('modalKpmDisplay');
            modalAccuracyDisplay = document.getElementById('modalAccuracyDisplay');
            modalTimeDisplay = document.getElementById('modalTimeDisplay');
            modalMissesDisplay = document.getElementById('modalMissesDisplay');
            modalTypedCharsDisplay = document.getElementById('modalTypedCharsDisplay');
            modalMistypedStatsList = document.getElementById('modalMistypedStatsList');
            retryBtnModal = document.getElementById('retryBtnModal');
            
            totalPlaysStat = document.getElementById('totalPlaysStat');
            totalPlayTimeStat = document.getElementById('totalPlayTimeStat');
            totalTypedCharactersStat = document.getElementById('totalTypedCharactersStat');
            totalOverallMistakesStat = document.getElementById('totalOverallMistakesStat');
            avgKpmStat = document.getElementById('avgKpmStat');
            avgAccuracyStat = document.getElementById('avgAccuracyStat');
            totalMistypedKeysListElement = document.getElementById('totalMistypedKeysList');
            resetAllStatsBtn = document.getElementById('resetAllStatsBtn');

            readAloudToggle = document.getElementById('readAloudToggle');
            readAloudOptionsContainer = document.getElementById('readAloudOptionsContainer');
            readAloudTargetSelect = document.getElementById('readAloudTargetSelect');
            readAloudVoiceJaSelect = document.getElementById('readAloudVoiceJaSelect');
            readAloudRateJaSelect = document.getElementById('readAloudRateJaSelect');
            readAloudVoiceEnSelect = document.getElementById('readAloudVoiceEnSelect');
            readAloudRateEnSelect = document.getElementById('readAloudRateEnSelect');
        }

        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            resetBtn.addEventListener('click', resetGame);
            problemAreaElement.addEventListener('click', () => inputField.focus());
            settingsBtn.addEventListener('click', () => openModal(settingsModal));
            wordRegistrationBtn.addEventListener('click', () => {
                renderManageWordLists();
                openModal(wordRegistrationModal);
            });
            totalStatsBtn.addEventListener('click', () => {
                displayTotalStats();
                openModal(totalStatsModal);
            });
            document.querySelectorAll('.modal-close-btn').forEach(btn => {
                const modal = document.getElementById(btn.dataset.modal);
                if(modal) btn.addEventListener('click', () => closeModal(modal));
            });
            window.addEventListener('click', e => { if (e.target.classList.contains('modal')) closeModal(e.target); });
            modeSelect.addEventListener('change', e => {
                currentMode = e.target.value;
                updateModeOptionsVisibility();
                saveSettings();
                if (!gameActive && !gamePendingStart) loadInitialProblemDisplay();
            });
            timeLimitSelect.addEventListener('change', e => {
                currentTimeLimit = parseInt(e.target.value, 10);
                saveSettings();
                if (!gameActive && !gamePendingStart) loadInitialProblemDisplay();
            });
            normalModeProblemCountSelect.addEventListener('change', e => {
                currentNormalModeProblemCount = parseInt(e.target.value, 10);
                saveSettings();
                if (!gameActive && !gamePendingStart) loadInitialProblemDisplay();
            });
            soundToggle.addEventListener('change', e => {
                soundEnabled = e.target.checked;
                saveSettings();
                if (soundEnabled && !audioContextStarted) initializeAudio();
            });
            setupThemeSelector();
            retryBtnModal.addEventListener('click', () => { closeModal(resultsModal); resetGame(); startGame(); });
            document.addEventListener('keydown', handleGlobalKeydown);
            problemAreaElement.addEventListener('keydown', handleGlobalKeydown);
            inputField.addEventListener('keydown', handleKeydown);
            
            createWordListBtn.addEventListener('click', createNewWordList);
            addWordBtn.addEventListener('click', addWordToSelectedList);
            wordFileInput.addEventListener('change', handleFileUpload);
            viewRegisteredWordsListSelect.addEventListener('change', () => displayWordsInSelectedListForView());
            resetAllStatsBtn.addEventListener('click', resetAllStatistics);
            confirmOkBtn.addEventListener('click', () => closeConfirmModal(true));
            confirmCancelBtn.addEventListener('click', () => closeConfirmModal(false));
            saveRenameListBtn.addEventListener('click', () => closeRenameListModal(editListNameInput.value));
            cancelRenameListBtn.addEventListener('click', () => closeRenameListModal(null));

            readAloudToggle.addEventListener('change', handleReadAloudToggle);
            readAloudTargetSelect.addEventListener('change', () => { readAloudSettings.target = readAloudTargetSelect.value; saveSettings(); });
            readAloudRateJaSelect.addEventListener('change', () => { readAloudSettings.rateJa = parseFloat(readAloudRateJaSelect.value); saveSettings(); });
            readAloudVoiceJaSelect.addEventListener('change', () => { readAloudSettings.voiceJaURI = readAloudVoiceJaSelect.value; saveSettings(); });
            readAloudRateEnSelect.addEventListener('change', () => { readAloudSettings.rateEn = parseFloat(readAloudRateEnSelect.value); saveSettings(); });
            readAloudVoiceEnSelect.addEventListener('change', () => { readAloudSettings.voiceEnURI = readAloudVoiceEnSelect.value; saveSettings(); });
        }
        
        function setupThemeSelector() {
            const options = themeSelector.querySelectorAll('.option');
            options.forEach(option => {
                option.addEventListener('click', (e) => {
                    const themeValue = e.currentTarget.dataset.value;
                    applyTheme(themeValue);
                    saveSettings();
                });
            });
        }
        function updateThemeSelectorUI() {
            const selectedOption = themeSelector.querySelector(`.option[data-value="${currentTheme}"]`);
            if (selectedOption) {
                themeSelector.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
                selectedOption.classList.add('selected');
            }
        }
        function loadSettings() {
            const saved = localStorage.getItem(SETTINGS_KEY);
            if (saved) {
                const s = JSON.parse(saved);
                currentMode = s.mode || 'normal';
                currentTimeLimit = s.timeLimit || 60;
                currentNormalModeProblemCount = s.normalModeProblemCount || 50;
                currentTheme = s.theme || 'light';
                soundEnabled = typeof s.soundEnabled === 'boolean' ? s.soundEnabled : true;
                if(s.readAloud) readAloudSettings = { ...readAloudSettings, ...s.readAloud };
            }
            modeSelect.value = currentMode;
            timeLimitSelect.value = currentTimeLimit;
            normalModeProblemCountSelect.value = currentNormalModeProblemCount;
            soundToggle.checked = soundEnabled;
            applyTheme(currentTheme);
            updateModeOptionsVisibility();

            readAloudToggle.checked = readAloudSettings.enabled;
            readAloudOptionsContainer.style.display = readAloudSettings.enabled ? 'block' : 'none';
            readAloudTargetSelect.value = readAloudSettings.target;
            readAloudRateJaSelect.value = readAloudSettings.rateJa;
            readAloudRateEnSelect.value = readAloudSettings.rateEn;
        }
        function saveSettings() {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify({
                mode: currentMode,
                timeLimit: currentTimeLimit,
                normalModeProblemCount: currentNormalModeProblemCount,
                theme: currentTheme,
                soundEnabled: soundEnabled,
                readAloud: readAloudSettings,
            }));
        }
        function updateModeOptionsVisibility() {
            timeLimitOptions.classList.toggle('hidden', currentMode !== 'timeLimit');
            normalModeOptions.classList.toggle('hidden', currentMode !== 'normal');
        }
        function applyTheme(themeName) {
            document.body.className = `theme-${themeName}`;
            currentTheme = themeName;
            updateThemeSelectorUI();
        }
        
        function initializeAudio(){if(Tone.context.state!=="running"){Tone.start()}audioContextStarted=true;synth=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:.005,decay:.1,sustain:0,release:.1},volume:-20}).toDestination();errSynth=new Tone.Synth({oscillator:{type:"square"},envelope:{attack:.01,decay:.2,sustain:0,release:.1},volume:-22}).toDestination();correctSynth=new Tone.Synth({oscillator:{type:"triangle"},envelope:{attack:.005,decay:.05,sustain:0,release:.1},volume:-18}).toDestination();startSynth=new Tone.Synth({oscillator:{type:"sawtooth"},envelope:{attack:.01,decay:.1,sustain:.05,release:.2},volume:-25}).toDestination();endSynth=new Tone.FMSynth({harmonicity:3.01,modulationIndex:14,detune:0,oscillator:{type:"sine"},envelope:{attack:.01,decay:.5,sustain:.1,release:.5},modulation:{type:"square"},modulationEnvelope:{attack:.01,decay:.5,sustain:0,release:0.5},volume:-20}).toDestination()}
        function playSound(e){if(!soundEnabled||!audioContextStarted)return;try{switch(e){case"type":synth?.triggerAttackRelease("C5","8n");break;case"error":errSynth?.triggerAttackRelease("C3","8n");break;case"correctWord":correctSynth?.triggerAttackRelease("G5","16n",Tone.now()+.05);break;case"gameStart":startSynth?.triggerAttackRelease("C4","4n");break;case"gameEnd":endSynth?.triggerAttackRelease("C3","2n");break}}catch(e){}}
        function showToast(e,t="info",o=3e3){const n=document.getElementById("toast-container");if(!n)return;const a=document.createElement("div");a.className=`toast-message ${t}`;let s="";t==="success"?s="fas fa-check-circle":t==="error"?s="fas fa-times-circle":t==="info"&&(s="fas fa-info-circle"),a.innerHTML=`${s?`<i class="${s}"></i>`:""}<span>${e}</span>`,n.appendChild(a),setTimeout(()=>{a.remove()},o)}
        function showCustomConfirm(e){return confirmOkBtn.className="modal-button danger w-full py-2 rounded-lg font-semibold",new Promise(t=>{confirmResolve=t,confirmMessageText.textContent=e,openModal(customConfirmModal)})}
        function showRenameListModal(e,t){return new Promise(o=>{renameListResolve=o,editListNameInput.value=t,openModal(renameListModal)})}
        function closeConfirmModal(e){closeModal(customConfirmModal),confirmResolve&&(confirmResolve(e),confirmResolve=null)}
        function closeRenameListModal(e){closeModal(renameListModal),renameListResolve&&(renameListResolve(e),renameListResolve=null)}
        async function handleManageListActions(e){const t=e.target,o=t.closest(".word-list-item");if(!o)return;const n=o.dataset.listId;if(t.matches(".rename-list-btn, .rename-list-btn *")){const e=wordLists.find(e=>e.id===n);if(!e)return;const t=await showRenameListModal(n,e.name);t&&t.trim()&&t.trim()!==e.name&&(wordLists.find(e=>e.name===t.trim()&&e.id!==n)?showToast("同じ名前のリストが既に存在します。","error"):(e.name=t.trim(),saveWordLists(),renderManageWordLists(),showToast(`リスト名を「${e.name}」に変更しました。`,"success")))}else if(t.matches(".delete-list-btn, .delete-list-btn *")){const e=wordLists.find(e=>e.id===n);if(e&&await showCustomConfirm(`リスト「${e.name}」を削除しますか？`))wordLists=wordLists.filter(e=>e.id!==n),saveWordLists(),renderManageWordLists(),showToast(`リスト「${e.name}」を削除しました。`,"info")}else if(t.matches(".practice-list-item-checkbox")){const e=wordLists.find(e=>e.id===n);e&&(e.selectedForPractice=t.checked,saveWordLists())}}
        function updateCurrentWordsListFromSelections(){currentWords=[],wordLists.forEach(e=>{e.selectedForPractice&&currentWords.push(...e.words)}),currentMode==="normal"&&(practiceSessionWordPool=[],practiceSessionWordPoolIndex=0),gameActive||gamePendingStart||loadInitialProblemDisplay()}
        function updateProgressBar(){if(!gameProgressBar)return;let e=0;gameActive&&currentMode==="normal"&&problemSet&&problemSet.length>0?e=problemSetIndex/problemSet.length*100:gameActive&&currentMode==="timeLimit"&&gameStartTime&&(e=(new Date-gameStartTime)/1e3/currentTimeLimit*100),gameProgressBar.style.width=`${Math.max(0,Math.min(100,e))}%`}
        function openModal(e){e?.classList.add("show")}function closeModal(e){e?.classList.remove("show")}
        function generateId(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}
        function loadWordLists(){const e=localStorage.getItem(WORD_LISTS_KEY);wordLists=e?JSON.parse(e):[],renderManageWordLists(),updateCurrentWordsListFromSelections()}
        function saveWordLists(){localStorage.setItem(WORD_LISTS_KEY,JSON.stringify(wordLists)),updateCurrentWordsListFromSelections()}
        async function createNewWordList(){const e=newListNameInput.value.trim();e?(wordLists.find(t=>t.name===e)?showToast("同じ名前のリストが既に存在します。","error"):(wordLists.push({id:generateId(),name:e,words:[],selectedForPractice:!1}),newListNameInput.value="",saveWordLists(),renderManageWordLists(),showToast(`リスト「${e}」を作成しました。`,"success"))):showToast("リスト名を入力してください。","error")}
        function renderManageWordLists(){if(!manageWordListsContainer||!addWordToListSelect||!addWordsFromFileToListSelect||!viewRegisteredWordsListSelect)return;manageWordListsContainer.innerHTML="",addWordToListSelect.innerHTML="",addWordsFromFileToListSelect.innerHTML="",viewRegisteredWordsListSelect.innerHTML="";const e=new Option("登録先リストなし","");if(e.disabled=!0,wordLists.length===0)return manageWordListsContainer.innerHTML='<p class="text-sm text-gray-500">まだリストがありません。</p>',addWordToListSelect.add(e.cloneNode(!0)),addWordsFromFileToListSelect.add(e.cloneNode(!0)),viewRegisteredWordsListSelect.add(e.cloneNode(!0)),void displayWordsInSelectedListForView();wordLists.forEach(t=>{const o=document.createElement("div");o.className="word-list-item flex items-center gap-2 p-1 border-b border-[var(--border-color)]",o.dataset.listId=t.id;const n=document.createElement("input");n.type="checkbox",n.className="practice-list-item-checkbox h-5 w-5 rounded",n.checked=t.selectedForPractice||!1;const a=document.createElement("span");a.className="list-name flex-grow",a.textContent=`${t.name} (${t.words.length}語)`;const s=document.createElement("div");s.className="list-actions flex gap-2";const r=document.createElement("button");r.className="rename-list-btn modal-button secondary p-1 text-xs aspect-square rounded",r.innerHTML='<i class="fas fa-pencil-alt"></i>';const i=document.createElement("button");i.className="delete-list-btn modal-button danger p-1 text-xs aspect-square rounded",i.innerHTML='<i class="fas fa-trash"></i>',s.appendChild(r),s.appendChild(i),o.appendChild(n),o.appendChild(a),o.appendChild(s),manageWordListsContainer.appendChild(o),addWordToListSelect.add(new Option(t.name,t.id)),addWordsFromFileToListSelect.add(new Option(t.name,t.id)),viewRegisteredWordsListSelect.add(new Option(t.name,t.id))}),manageWordListsContainer.removeEventListener("click",handleManageListActions),manageWordListsContainer.addEventListener("click",handleManageListActions),viewRegisteredWordsListSelect.options.length>0&&(viewRegisteredWordsListSelect.selectedIndex=0),displayWordsInSelectedListForView()}
        async function addWordToSelectedList(){const e=addWordToListSelect.value;if(!e)return void showToast("単語の登録先リストを選択してください。","error");const t=wordLists.find(t=>t.id===e);if(!t)return void showToast("選択されたリストが見つかりません。","error");let o=newWordNoteInput.value.trim(),n=newWordDisplayInput.value.trim();if(!n&&!o)return void showToast("「表示する日本語」または「タイプする文字列」のどちらかは入力してください。","error");const a=(n||o).toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g," ").trim(),s=(o||n).trim();if(!a)return void showToast("タイプする有効な文字列がありません。","error");if(t.words.some(e=>e.display===a&&e.note===s))return void showToast("この単語の組み合わせは選択されたリストに既に登録されています。","error");t.words.push({id:generateId(),display:a,note:s}),saveWordLists(),renderManageWordLists(),newWordDisplayInput.value="",newWordNoteInput.value="",showToast(`「${s} / ${a}」をリスト「${t.name}」に登録しました。`,"success"),newWordNoteInput.focus()}
        function handleFileUpload(e){const t=e.target.files[0];if(!t)return;const o=addWordsFromFileToListSelect.value;if(!o)return e.target.value="",void showToast("単語のインポート先リストを選択してください。","error");const n=wordLists.find(e=>e.id===o);if(!n)return e.target.value="",void showToast("選択されたリストが見つかりません。","error");const a=document.querySelector('input[name="fileFormat"]:checked').value,s=new FileReader;s.onload=t=>{const o=t.target.result;processUploadedWordsToList(o,a,n),e.target.value=""},s.onerror=()=>{showToast("ファイルの読み込みに失敗しました。","error"),e.target.value=""},s.readAsText(t)}
        function processUploadedWordsToList(e,t,o){const n=e.split(/\r\n|\n|\r/);let a=0,s=0;n.forEach(e=>{e=e.trim();if(""===e)return;let n="",r="";const i=e.split(",");t==="type_prompt"?(n=(i[0]||"").trim(),r=(i.length>1?i.slice(1).join(","):n).trim()):(r=(i[0]||"").trim(),n=(i.length>1?i.slice(1).join(","):r).trim());const l=(n||r).toLowerCase().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g," ").trim(),c=(r||n).trim();l?(o.words.some(e=>e.display===l&&e.note===c)?s++:(o.words.push({id:generateId(),display:l,note:c}),a++)):s++}),a>0?(saveWordLists(),renderManageWordLists(),showToast(`${a}件の新しい単語をリスト「${o.name}」に登録しました。${s>0?s+"件は重複または無効でスキップされました。":""}`,"success")):showToast(`登録できる新しい単語が見つからなかったか、内容は全て既存の単語でした。(スキップ: ${s}件)`,"info")}
        function displayWordsInSelectedListForView(){if(!viewRegisteredWordsListSelect||!registeredWordsListElement)return;const e=viewRegisteredWordsListSelect.value;if(registeredWordsListElement.innerHTML="",!e)return void(registeredWordsListElement.innerHTML='<p class="text-gray-500">表示するリストを選択してください。</p>');const t=wordLists.find(t=>t.id===e);if(!t||t.words.length===0)return void(registeredWordsListElement.innerHTML='<p class="text-gray-500">このリストには単語がありません。</p>');t.words.forEach(e=>{const t=document.createElement("div");t.className="flex justify-between items-center py-1",t.innerHTML=`<span>表示: ${e.note||"(空)"} / タイプ: ${e.display}</span><button class="delete-word-btn text-xs text-red-500 hover:text-red-700" data-word-id="${e.id}"><i class="fas fa-times"></i></button>`,registeredWordsListElement.appendChild(t)}),registeredWordsListElement.removeEventListener("click",handleDeleteWordInView),registeredWordsListElement.addEventListener("click",handleDeleteWordInView)}
        async function handleDeleteWordInView(e){const t=e.target.closest(".delete-word-btn");if(!t)return;const o=viewRegisteredWordsListSelect.value,n=t.dataset.wordId,a=wordLists.find(e=>e.id===o);if(a){const e=a.words.find(e=>e.id===n);if(e&&await showCustomConfirm(`単語「${e.note} / ${e.display}」を削除しますか？`))a.words=a.words.filter(e=>e.id!==n),saveWordLists(),renderManageWordLists(),showToast("単語を削除しました。","info")}}
        function prepareNormalModeProblems(){if(currentWords.length===0)return problemSet=[],problemSetIndex=0,void updateProgressBar();if(practiceSessionWordPool.length===0||practiceSessionWordPoolIndex>=practiceSessionWordPool.length){practiceSessionWordPool=[...currentWords];for(let e=practiceSessionWordPool.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[practiceSessionWordPool[e],practiceSessionWordPool[t]]=[practiceSessionWordPool[t],practiceSessionWordPool[e]]}practiceSessionWordPoolIndex=0}problemSet=[];for(let e=0;e<currentNormalModeProblemCount;e++){if(practiceSessionWordPoolIndex>=practiceSessionWordPool.length){if(currentWords.length<=0)break;practiceSessionWordPool=[...currentWords];for(let e=practiceSessionWordPool.length-1;e>0;e--){const t=Math.floor(Math.random()*(e+1));[practiceSessionWordPool[e],practiceSessionWordPool[t]]=[practiceSessionWordPool[t],practiceSessionWordPool[e]]}practiceSessionWordPoolIndex=0}if(practiceSessionWordPool.length===0)break;problemSet.push(practiceSessionWordPool[practiceSessionWordPoolIndex++])}problemSetIndex=0,updateProgressBar()}
        function getNextProblemForNormalMode(){return problemSetIndex<problemSet.length?problemSet[problemSetIndex++]:null}
        function getRandomProblemForTimeLimit(){return currentWords.length===0?null:currentWords[Math.floor(Math.random()*currentWords.length)]}
        function renderProblemStatic(){problemTextStaticElement.textContent=currentProblem?currentProblem.note||currentProblem.display:"準備完了"}
        function renderProblemDynamic(){problemTextDynamicElement.innerHTML="",problemToType.split("").forEach(e=>{const t=document.createElement("span");t.className="char-span inline-block px-1",t.textContent=e,problemTextDynamicElement.appendChild(t)}),highlightNextChar()}
        function highlightNextChar(){const e=problemTextDynamicElement.querySelectorAll(".char-span");e.forEach(e=>e.classList.remove("next-char-highlight")),e[currentProblemCharIndex]?.classList.add("next-char-highlight")}
        function updateTypedCharDisplay(e,t){const o=problemTextDynamicElement.querySelectorAll(".char-span");o[e]&&(o[e].classList.remove("next-char-highlight"),o[e].classList.add(t?"correct":"incorrect"))}
        function loadInitialProblemDisplay(){if(currentWords.length===0)return problemTextStaticElement.textContent="練習する単語リストを選択・登録してください",problemTextDynamicElement.innerHTML="",startBtn.disabled=!0,currentProblem=null,problemToType="",updateProgressBar(),!1;startBtn.disabled=!1,problemSetIndex=0,currentMode==="normal"?(prepareNormalModeProblems(),problemSet.length===0?(problemTextStaticElement.textContent="選択されたリストに練習可能な単語がありません。",startBtn.disabled=!0,currentProblem=null,problemToType="",updateProgressBar(),!1):(currentProblem=problemSet[problemSetIndex])):currentProblem=getRandomProblemForTimeLimit();if(!currentProblem)return problemTextStaticElement.textContent="練習可能な単語がありません。",problemTextDynamicElement.innerHTML="",startBtn.disabled=!0,problemToType="",updateProgressBar(),!1;return problemToType=currentProblem.display,problemAreaElement.classList.remove("game-in-progress"),startBtn.disabled=!1,countdownDisplay.textContent=currentMode==="timeLimit"?currentTimeLimit:"--",currentKpmDisplay.textContent="0",wordCompleted=!1,problemTextStaticElement.textContent="準備完了。スペースキーで問題表示！",updateProgressBar(),!0}
        function startGame(){if(gameActive||gamePendingStart)return;if(!audioContextStarted)initializeAudio();updateCurrentWordsListFromSelections();if(currentWords.length===0)return showToast("練習する単語がありません。リストを選択するか、単語を登録してください。","error");gamePendingStart=!0,gameActive=!1,currentProblemCharIndex=0,correctStrokes=0,incorrectStrokes=0,totalTypedInGame=0,mistypedKeysStats={},wordCompleted=!1,currentMode==="normal"?(prepareNormalModeProblems(),problemSet.length===0?(showToast("選択されたリストに練習可能な単語がありません。","info"),gamePendingStart=!1,!1):(currentProblem=getNextProblemForNormalMode())):currentProblem=getRandomProblemForTimeLimit();if(!currentProblem)return showToast("練習可能な単語がありません。","error"),gamePendingStart=!1,!1;problemToType=currentProblem.display,problemAreaElement.classList.add("game-in-progress"),startBtn.disabled=!0,resetBtn.disabled=!1,inputField.value="",inputField.focus(),renderProblemStatic(),renderProblemDynamic(),triggerReadAloud(),countdownDisplay.textContent=currentMode==="timeLimit"?currentTimeLimit:"--",currentKpmDisplay.textContent="0",updateProgressBar()}
        function updateCountdownDisplay(){if(!countdownDisplay)return;const e=parseInt(countdownDisplay.textContent,10);e>1?(countdownDisplay.textContent=e-1,currentMode==="timeLimit"&&updateProgressBar()):endGame()}
        function resetGame(){gameActive=!1,gamePendingStart=!1,clearInterval(timerInterval),speechSynthesis.cancel(),currentProblemCharIndex=0,problemToType="",correctStrokes=0,incorrectStrokes=0,totalTypedInGame=0,problemSetIndex=0,inputField.value="",inputField.blur(),startBtn.disabled=!1,resetBtn.disabled=!0,problemAreaElement.classList.remove("game-in-progress"),loadInitialProblemDisplay()}
        function endGame(){if(!gameActive&&!gamePendingStart)return;gameActive=!1,gamePendingStart=!1,clearInterval(timerInterval),speechSynthesis.cancel(),playSound("gameEnd"),problemAreaElement.classList.remove("game-in-progress"),updateProgressBar();const e=gameStartTime?(new Date-gameStartTime)/1e3:0,t=totalTypedInGame>0?Math.round(correctStrokes/totalTypedInGame*100):0,o=e>0&&correctStrokes>0?Math.round(correctStrokes/e*60):0;modalKpmDisplay.textContent=o,modalAccuracyDisplay.textContent=`${t}%`,modalTimeDisplay.textContent=e.toFixed(1),modalMissesDisplay.textContent=incorrectStrokes,modalTypedCharsDisplay.textContent=correctStrokes,displayCurrentGameMistypedStats(),openModal(resultsModal),startBtn.disabled=!1,resetBtn.disabled=!0,e>0&&totalTypedInGame>0&&updateTotalPlayStats({time:e,typed:correctStrokes,mistakes:incorrectStrokes,kpm:o,accuracy:t}),inputField.blur()}
        function handleGlobalKeydown(e){if(" "===e.key||"Space"===e.code){const t=document.activeElement;if(t===inputField||t===problemAreaElement||!["INPUT","SELECT","TEXTAREA","BUTTON"].includes(t.tagName)){const o=document.querySelector(".modal.show:not(#resultsModal)");if(o)return;if(e.preventDefault(),!gameActive&&!gamePendingStart)return resultsModal.classList.contains("show")?(closeModal(resultsModal),resetGame()):void startGame();wordCompleted&&gameActive&&proceedToNextProblem()}}}
        function proceedToNextProblem(){if(!wordCompleted)return;wordCompleted=!1,currentProblemCharIndex=0,currentMode==="timeLimit"?currentProblem=getRandomProblemForTimeLimit():currentProblem=getNextProblemForNormalMode(),currentProblem?(problemToType=currentProblem.display,renderProblemStatic(),renderProblemDynamic(),triggerReadAloud(),inputField.focus(),updateProgressBar()):endGame()}
        function handleKeydown(e){if(!gameActive&&!gamePendingStart)return;if(gamePendingStart){if(e.key.length>1)return;gameActive=!0,gamePendingStart=!1,gameStartTime=new Date,playSound("gameStart"),currentMode==="timeLimit"&&(countdownDisplay.textContent=currentTimeLimit,clearInterval(timerInterval),timerInterval=setInterval(updateCountdownDisplay,1e3)),updateTotalPlayStats({plays:1}),updateProgressBar()}if(!gameActive||!problemToType)return;if(wordCompleted)return;if(currentProblemCharIndex>=problemToType.length)return;if(e.preventDefault(),e.key.length>1)return;totalTypedInGame++;const t=problemToType[currentProblemCharIndex].toLowerCase();e.key.toLowerCase()===t?(correctStrokes++,playSound("type"),updateTypedCharDisplay(currentProblemCharIndex,!0),currentProblemCharIndex++):(incorrectStrokes++,recordMistake(t),playSound("error"),updateTypedCharDisplay(currentProblemCharIndex,!1));const o=(new Date-gameStartTime)/1e3;currentKpmDisplay.textContent=o>0&&correctStrokes>0?Math.round(correctStrokes/o*60):0,currentProblemCharIndex>=problemToType.length&&(wordCompleted=!0,playSound("correctWord"),problemTextDynamicElement.querySelectorAll(".char-span").forEach(e=>{e.classList.add("correct"),e.classList.remove("incorrect","incorrect-space","next-char-highlight")}))}
        function recordMistake(e){e=e.toLowerCase(),mistypedKeysStats[e]=(mistypedKeysStats[e]||0)+1,totalMistypedKeys[e]=(totalMistypedKeys[e]||0)+1}
        function displayCurrentGameMistypedStats(){modalMistypedStatsList.innerHTML="";const e=Object.entries(mistypedKeysStats).sort(([,e],[,t])=>t-e).slice(0,5);if(e.length===0)modalMistypedStatsList.innerHTML='<span class="text-gray-500">ミスタッチなし！</span>';else{e.forEach(([e,t])=>{const o=document.createElement("span");o.className="px-2 py-1 bg-red-100 text-red-700 rounded text-xs",o.textContent=`${e}: ${t}回`,modalMistypedStatsList.appendChild(o)})}}
        function loadTotalMistypedKeys(){const e=localStorage.getItem(TOTAL_MISTYPED_KEYS_KEY);totalMistypedKeys=e?JSON.parse(e):{}}
        function saveTotalMistypedKeys(){localStorage.setItem(TOTAL_MISTYPED_KEYS_KEY,JSON.stringify(totalMistypedKeys))}
        function displayTotalStats(){totalMistypedKeysListElement.innerHTML="";const e=Object.entries(totalMistypedKeys).sort(([,e],[,t])=>t-e).slice(0,5);if(e.length===0)totalMistypedKeysListElement.innerHTML='<span class="text-gray-500">累計ミスタッチはありません。</span>';else{e.forEach(([e,t])=>{const o=document.createElement("span");o.className="px-2 py-1 bg-orange-100 text-orange-700 rounded text-xs",o.textContent=`${e}: ${t}回`,totalMistypedKeysListElement.appendChild(o)})}totalPlaysStat.textContent=currentTotalPlayStats.plays.toLocaleString(),totalPlayTimeStat.textContent=`${currentTotalPlayStats.playTime.toLocaleString(void 0,{maximumFractionDigits:0})}秒`,totalTypedCharactersStat.textContent=currentTotalPlayStats.typedChars.toLocaleString(),totalOverallMistakesStat.textContent=currentTotalPlayStats.mistypedKeysOverall.toLocaleString(),avgKpmStat.textContent=currentTotalPlayStats.plays>0?(currentTotalPlayStats.kpmSum/currentTotalPlayStats.plays).toFixed(0):0,avgAccuracyStat.textContent=currentTotalPlayStats.plays>0?`${(currentTotalPlayStats.accuracySum/currentTotalPlayStats.plays).toFixed(1)}%`:"0%"}
        let currentTotalPlayStats={plays:0,playTime:0,typedChars:0,mistypedKeysOverall:0,kpmSum:0,accuracySum:0};
        function loadTotalPlayStats(){const e=localStorage.getItem(TOTAL_PLAY_STATS_KEY);e&&(currentTotalPlayStats=JSON.parse(e))}
        function saveTotalPlayStats(){localStorage.setItem(TOTAL_PLAY_STATS_KEY,JSON.stringify(currentTotalPlayStats))}
        function updateTotalPlayStats(e){e.plays&&(currentTotalPlayStats.plays+=e.plays),e.time&&(currentTotalPlayStats.playTime+=e.time),e.typed&&(currentTotalPlayStats.typedChars+=e.typed),e.mistakes&&(currentTotalPlayStats.mistypedKeysOverall+=e.mistakes),e.kpm&&(currentTotalPlayStats.kpmSum+=e.kpm),e.accuracy&&(currentTotalPlayStats.accuracySum+=e.accuracy),saveTotalPlayStats(),saveTotalMistypedKeys()}
        async function resetAllStatistics(){if(await showCustomConfirm("本当にすべての統計情報（累計成績、苦手キー）をリセットしますか？"))currentTotalPlayStats={plays:0,playTime:0,typedChars:0,mistypedKeysOverall:0,kpmSum:0,accuracySum:0},totalMistypedKeys={},localStorage.removeItem(TOTAL_PLAY_STATS_KEY),localStorage.removeItem(TOTAL_MISTYPED_KEYS_KEY),showToast("すべての統計情報をリセットしました。","info"),displayTotalStats()}
        function initSpeechSynthesis(){if("speechSynthesis"in window)speechSynthesis.onvoiceschanged=populateVoiceLists,populateVoiceLists();else{const e=document.querySelector("#readAloudToggle").closest("div");e.style.display="none"}}
        function populateVoiceLists(){synthVoices=speechSynthesis.getVoices(),readAloudVoiceJaSelect.innerHTML="",readAloudVoiceEnSelect.innerHTML="";const e=synthVoices.filter(e=>e.lang.startsWith("ja")),t=synthVoices.filter(e=>e.lang.startsWith("en"));e.forEach(e=>{const t=new Option(`${e.name} (${e.lang})`,e.voiceURI);readAloudVoiceJaSelect.add(t)}),t.forEach(e=>{const t=new Option(`${e.name} (${e.lang})`,e.voiceURI);readAloudVoiceEnSelect.add(t)}),readAloudSettings.voiceJaURI&&readAloudVoiceJaSelect.value?readAloudVoiceJaSelect.value=readAloudSettings.voiceJaURI:e.length>0&&(readAloudVoiceJaSelect.selectedIndex=0,readAloudSettings.voiceJaURI=e[0].voiceURI),readAloudSettings.voiceEnURI&&readAloudVoiceEnSelect.value?readAloudVoiceEnSelect.value=readAloudSettings.voiceEnURI:t.length>0&&(readAloudVoiceEnSelect.selectedIndex=0,readAloudSettings.voiceEnURI=t[0].voiceURI)}
        function handleReadAloudToggle(e){readAloudSettings.enabled=e.target.checked,readAloudOptionsContainer.style.display=readAloudSettings.enabled?"block":"none",saveSettings()}
        function speak(e,t,o,n){if(!readAloudSettings.enabled||!e)return;speechSynthesis.cancel();const a=new SpeechSynthesisUtterance(e),s=synthVoices.find(e=>e.voiceURI===o);a.voice=s||synthVoices.find(e=>e.lang.startsWith(t)&&e.default),a.lang=t,a.rate=n,speechSynthesis.speak(a)}
        function triggerReadAloud(){if(readAloudSettings.enabled&&currentProblem){const e=readAloudSettings.target,t=currentProblem.note||"",o=currentProblem.display||"";if("prompt"===e||"both"===e)speak(t,"ja-JP",readAloudSettings.voiceJaURI,readAloudSettings.rateJa);"typing"!==e&&"both"!==e||setTimeout(()=>{speak(o,"en-US",readAloudSettings.voiceEnURI,readAloudSettings.rateEn)},"both"===e&&t?1e3:0)}}
    </script>
</body>
</html>
